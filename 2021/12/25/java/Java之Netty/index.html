<!DOCTYPE html>


<html lang="zh-cn">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="Java" />
       
      <meta name="description" content="chengpeng&#39;s blogs" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Javaä¹‹Netty.md |  chengpeng&#39;s blogs</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="chengpeng's blogs" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-java/Javaä¹‹Netty"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Javaä¹‹Netty.md
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/12/25/java/Java%E4%B9%8BNetty/" class="article-date">
  <time datetime="2021-12-25T02:18:43.000Z" itemprop="datePublished">2021-12-25</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">3.3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading timeâ‰ˆ</span>
            <span class="post-count">14 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Nettyæ˜¯ä¸€å¥—æ”¯æŒNIOçš„å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¡†æ¶ã€‚<br>é«˜æ€§èƒ½ã€é«˜å¹¶å‘ã€‚<br>æ”¯æŒå¼‚æ­¥é€šä¿¡ã€‚<br>ä»–æ˜¯ä½¿ç”¨Javaç¼–å†™çš„ã€‚<br>åœ¨Javaé¢†åŸŸä¸­ï¼Œä»–æ˜¯IOç•Œçš„è€å¤§ï¼Œç‰¹åˆ«æ˜¯ç½‘ç»œIOã€‚<br>å¾ˆå¤šé¡¹ç›®éƒ½ç”¨å®ƒï¼Œæ¯”å¦‚Dubboï¼ŒRocketMQï¼ŒCassandraç­‰ç­‰ã€‚</p>
<p>åœ¨è¿™ç‰‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ åˆ°ï¼š</p>
<ol>
<li>å¸¸è§çš„IOæ¨¡å‹</li>
<li>Nettyé¡¹ç›®</li>
<li>Nettyå®æˆ˜</li>
<li>Nettyåœ¨æˆ‘å¸ç”Ÿäº§ä¸­çš„åº”ç”¨</li>
</ol>
<p>é‚£æˆ‘ä»¬å¼€å§‹å§ï¼</p>
<span id="more"></span>

<h2 id="å¸¸è§çš„IOæ¨¡å‹"><a href="#å¸¸è§çš„IOæ¨¡å‹" class="headerlink" title="å¸¸è§çš„IOæ¨¡å‹"></a>å¸¸è§çš„IOæ¨¡å‹</h2><h3 id="BIOï¼Œé˜»å¡IO"><a href="#BIOï¼Œé˜»å¡IO" class="headerlink" title="BIOï¼Œé˜»å¡IO"></a>BIOï¼Œé˜»å¡IO</h3><blockquote>
<p>æ’é˜Ÿ</p>
</blockquote>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/PGtSwc.png"></p>
<p>å½“ä¸€ä¸ªIOè¯·æ±‚è¿‡æ¥ï¼Œå®¢æˆ·ç«¯è¿›å…¥ç­‰å¾…ï¼ŒæœåŠ¡ç«¯å¤„ç†æ•°æ®ï¼Œå¹¶ä¿æŒé˜»å¡ï¼ˆå…¶ä»–çš„å®¢æˆ·ç«¯è®¿é—®ä¸äº†ï¼‰ã€‚</p>
<p>ç­‰åˆ°æœåŠ¡ç«¯å¤„ç†å®Œæ•°æ®ï¼Œè¿”å›ç»™ç­‰å¾…ä¸­çš„å®¢æˆ·ç«¯ã€‚</p>
<p>å¾ˆåƒæˆ‘ä»¬æ’é˜Ÿä¹°é¸­å­çš„è¿‡ç¨‹ï¼ˆæ²¡é”™ï¼Œæˆ‘åœ¨å—äº¬ï¼‰ã€‚ä¸€ä¸ªä¸€ä¸ªæ¥ã€‚</p>
<p>ä»–çš„ä¼˜ç‚¹æ˜¯ï¼Œæ¨¡å‹å¾ˆç®€å•ï¼Œå®¹æ˜“å®ç°ï¼Œä¸”ä¸å®¹æ˜“å‡ºé—®é¢˜ã€‚<br>ç¡®å®šä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåœ¨å®¢æˆ·å¤šäº†çš„æ—¶å€™ï¼Œä½“éªŒä¼šå¾ˆä¸å¥½ã€‚</p>
<h3 id="NIOï¼Œéé˜»å¡IO"><a href="#NIOï¼Œéé˜»å¡IO" class="headerlink" title="NIOï¼Œéé˜»å¡IO"></a>NIOï¼Œéé˜»å¡IO</h3><blockquote>
<p>è½®è¯¢</p>
</blockquote>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/F7rzu9.png"></p>
<p>å®¢æˆ·ç«¯åœ¨æ‰§è¡Œäº†IOè¯·æ±‚ä¹‹åï¼Œä¼šç«‹åˆ»è¿”å›ç»“æœï¼Œè¦ä¸è¿”å›ç»“æœï¼Œè¦ä¸è¿˜éœ€ç­‰å¾…ã€‚<br>å¦‚æœè¿˜éœ€è¦ç­‰å¾…çš„è¯ï¼Œå®¢æˆ·ä¼šå‘èµ·è½®è¯¢ï¼Œä¸æ–­çš„è¯·æ±‚æœåŠ¡ç«¯ï¼Œç›´åˆ°è¿”å›ç»“æœã€‚</p>
<p>æ¯”å¦‚æˆ‘å»ä¹°ä¸€ä¸ªæ‰‹æŠ“é¥¼ï¼Œæˆ‘ä¸‹å•äº†ä¹‹åï¼Œéœ€è¦ç­‰å¾…ï¼Œå¹¶ä¸”è¿‡ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä¼šé—®ä¸€ä¸‹è€æ¿ï¼Œ<br>æˆ‘çš„æ‰‹æŠ“é¥¼å¥½äº†æ²¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†è¿‡ä¸€æ®µæ—¶é—´ï¼Œå†é—®ä¸‹è€æ¿ï¼Œæˆ‘çš„æ‰‹æŠ“é¥¼å¥½äº†æ²¡ã€‚<br>ç›´åˆ°è€æ¿æŠŠæ‰‹æŠ“é¥¼ç»™æˆ‘ã€‚</p>
<p>ä»–çš„ä¼˜åŠ¿æ˜¯å®ƒä¸ä¼šå†é˜»å¡äº†ï¼Œä¸ç”¨æ’é˜Ÿç­‰åœ¨é‚£é‡Œã€‚æˆ‘å¯ä»¥å¹²ä¸€äº›åˆ«çš„äº‹æƒ…ã€‚</p>
<p>ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œæˆ‘éœ€è¦ä¸æ–­çš„è¯¢é—®ï¼Œè¿™æ ·ä¹Ÿå¾ˆæ¶ˆè€—æ€§èƒ½ã€‚<br>è€Œä¸”å¦‚æœæˆ‘éœ€è¦çš„ç»“æœï¼ˆæ‰‹æŠ“é¥¼ï¼‰å·²ç»å‡†å¤‡å¥½ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰åŠæ—¶è¯¢é—®ï¼Œ<br>è¿™ç§æƒ…å†µï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°æ•°æ®çš„æ—¶é—´ä¼šæ™šäºçœŸå®çš„æ•°æ®æ—¶é—´ã€‚</p>
<h3 id="IOå¤šè·¯å¤ç”¨"><a href="#IOå¤šè·¯å¤ç”¨" class="headerlink" title="IOå¤šè·¯å¤ç”¨"></a>IOå¤šè·¯å¤ç”¨</h3><blockquote>
<p>äº‹ä»¶å¤„ç†</p>
</blockquote>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/BqbARO.png"></p>
<p>IOå¤šè·¯å¤ç”¨ï¼Œå®ƒæ˜¯æ¥å—å„ç§äº‹ä»¶ï¼ˆæ¯”å¦‚è¿æ¥ã€è¯»å–æˆ–å†™å…¥ã€é”™è¯¯å‘ç”Ÿç­‰)ã€‚<br>æ¥å—åˆ°å„ç§äº‹ä»¶æ¶ˆæ¯åï¼Œè®°å½•ä¸‹æ¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªæè¿°ç¬¦ã€‚</p>
<p>ç­‰åˆ°æ•°æ®å‡†å¤‡å®Œæˆï¼Œå†æ ¹æ®æè¿°ç¬¦æ‰¾åˆ°æ˜¯å“ªä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶é€šçŸ¥å®¢æˆ·ç«¯æ¥å–æ•°æ®ã€‚</p>
<p>æ‰“ä¸ªæ¯”æ–¹ï¼Œå°±åƒæˆ‘ä»¬æ’é˜Ÿä¹°å¥¶èŒ¶ï¼Œä¸‹å•ä¹‹åï¼Œæ‹¿åˆ°ä¸€ä¸ªå·ç ã€‚<br>ç­‰åˆ°å¥¶èŒ¶åšå¥½æ¥ä¹‹åï¼Œå¥¶èŒ¶åº—ä¼šå«å·ï¼Œè®©æˆ‘ä»¬å»å–å¥¶èŒ¶ã€‚</p>
<p>å®ƒçš„ä¼˜ç‚¹æ˜¯å¯ä»¥é‡Šæ”¾å®¢æˆ·ç«¯ï¼Œä¸éœ€è¦é˜»å¡ã€‚<br>å› ä¸ºä»…ä»…æ˜¯æ¥å—äº‹ä»¶ï¼Œä¸€ä¸ªçº¿ç¨‹å°±å¤Ÿäº†ï¼Œä¸è¦å¾ˆå¤šçº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚</p>
<p>åƒRedisï¼ŒNginxéƒ½æ˜¯ä½¿ç”¨çš„IOå¤šè·¯å¤ç”¨æ¨¡å‹ã€‚</p>
<h3 id="AIOã€å¼‚æ­¥IOæ¨¡å‹"><a href="#AIOã€å¼‚æ­¥IOæ¨¡å‹" class="headerlink" title="AIOã€å¼‚æ­¥IOæ¨¡å‹"></a>AIOã€å¼‚æ­¥IOæ¨¡å‹</h3><blockquote>
<p>å›è°ƒ</p>
</blockquote>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/FZRyq2.png"></p>
<p>è¿™ç§IOæ¨¡å‹å¾ˆåƒJSä¸­çš„AJAXï¼Œå‘èµ·ä¸€ä¸ªè¯·æ±‚ä¹‹åï¼Œç»§ç»­å¾€ä¸‹ä¹‹ååç»­é€»è¾‘ã€‚<br>ç­‰åˆ°æ•°æ®è¿”å›ä¹‹åï¼Œèµ°åˆ°å›è°ƒæ–¹æ³•ï¼Œå¹¶å‘æ•°æ®ç»“æœå¸¦è¿‡æ¥ã€‚</p>
<p>è¿™ç§å°±åƒç‚¹å¤–å–ï¼Œä¸‹å•ä¹‹åï¼Œç­‰åˆ°å¤–å–å‡†å¤‡å¥½ï¼Œç›´æ¥æŠŠå¤–å–é€åˆ°å®¶ã€‚</p>
<p>ä¼˜ç‚¹å°±æ˜¯ï¼Œéå¸¸é«˜æ•ˆï¼Œå®¢æˆ·ç«¯æœ‰ç€æœ€ä½³çš„æ€§èƒ½ã€‚<br>ç¼ºç‚¹å°±æ˜¯ï¼Œæ¨¡å‹ç»“æ„å¤æ‚ï¼Œä¸æ˜¯æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½èƒ½æ”¯æŒã€‚</p>
<h2 id="Nettyé¡¹ç›®ç»“æ„"><a href="#Nettyé¡¹ç›®ç»“æ„" class="headerlink" title="Nettyé¡¹ç›®ç»“æ„"></a>Nettyé¡¹ç›®ç»“æ„</h2><p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/7qmm3O.png"></p>
<p>Nettyæ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„IOæ¡†æ¶ï¼Œå®ƒæ”¯æŒå„ç§å„æ ·çš„åè®®ã€‚<br>å¯¹å„ç§IOæ¨¡å‹éƒ½æœ‰å°è£…ã€‚<br>æ›´å‹å¥½çš„æ“ä½œAPIã€‚<br>æ›´é«˜æ•ˆçš„æ€§èƒ½ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è‡ªå·±çœ‹ä¸€ä¸‹å®ƒã€‚</p>
<h3 id="Netty-IO-æ¨¡å‹"><a href="#Netty-IO-æ¨¡å‹" class="headerlink" title="Netty IO æ¨¡å‹"></a>Netty IO æ¨¡å‹</h3><p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/CqK8RW.png"></p>
<p>Nettyä½¿ç”¨çš„æ˜¯ååº”æ¨¡å‹çš„ä¸€ç§ï¼Œæœ‰ä¸»çº¿ç¨‹ç»„å’Œå·¥ä½œçº¿ç¨‹ç»„ã€‚<br>ä¸»çº¿ç¨‹ç»„è´Ÿè´£å¤„ç†å„ç§è¿æ¥ï¼Œå¹¶åˆ†å‘ä»»åŠ¡ç»™å·¥ä½œçº¿ç¨‹ç»„ã€‚<br>å·¥ä½œçº¿ç¨‹ç»„å°±è´Ÿè´£å¤„ç†å„ç§è¾“å…¥è¾“å‡ºè¯·æ±‚ã€‚å¹¶æ‰§è¡Œå®šä¹‰å¥½çš„pipelineã€‚</p>
<h3 id="ä¸‰å¤§æ ¸å¿ƒ"><a href="#ä¸‰å¤§æ ¸å¿ƒ" class="headerlink" title="ä¸‰å¤§æ ¸å¿ƒ"></a>ä¸‰å¤§æ ¸å¿ƒ</h3><h4 id="1ã€ChannelBuffer-ç¼“å†²åŒº"><a href="#1ã€ChannelBuffer-ç¼“å†²åŒº" class="headerlink" title="1ã€ChannelBuffer ç¼“å†²åŒº"></a>1ã€ChannelBuffer ç¼“å†²åŒº</h4><p>å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œå¤šç±»å‹ï¼ŒAPIå‹å¥½çš„ç¼“å†²åŒºç±»å‹ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨IOçš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿ç”¨åˆ°bufferï¼Œä¸ºè§£å†³é€Ÿç‡ä¸ä¸€è‡´ã€‚<br>ä½†æ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢å’ŒJavaåŸç”Ÿå±‚é¢ï¼Œåªæä¾›äº†ByteBufferã€‚å­—èŠ‚ç¼“å†²åŒºã€‚<br>éå¸¸çš„å•ä¸€ï¼Œè€Œä¸”æ“ä½œèµ·æ¥å¾ˆä¸æ–¹ä¾¿ã€‚</p>
<p>åœ¨Nettyä¸­ï¼Œå¯¹ç¼“å†²åŒºæœ‰äº†æ›´å¥½çš„å°è£…ã€‚è‡ªåŠ¨çš„è£…åŒ…å’Œæ‹†åŒ…ã€‚</p>
<p>è€Œä¸”ChannelBufferæ”¯æŒzero-copyï¼Œè¿™é‡Œçš„é›¶æ‹·è´ï¼Œä¸æ˜¯æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´ã€‚<br>å®ƒçš„åŸç†æ˜¯åœ¨ç”¨æˆ·æ¨¡å¼ç›´æ¥ç»´æŠ¤ä¸€ä¸ªå†…æ ¸æ¨¡å¼çš„bufferåœ°å€ï¼Œç›´æ¥è¿›è¡Œæ“ä½œã€‚<br>ä¸éœ€è¦å†è¿›è¡Œå†…æ ¸æ¨¡å¼åˆ‡æ¢ï¼ŒæŠŠbufferæ‹·è´åˆ°ç”¨æˆ·æ¨¡å¼é‡Œé¢æ¥ã€‚</p>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/lkHtRv.png"></p>
<h4 id="2ã€é€šç”¨API"><a href="#2ã€é€šç”¨API" class="headerlink" title="2ã€é€šç”¨API"></a>2ã€é€šç”¨API</h4><p>å¯¹BIOå’ŒNIOçš„é€šç”¨æŠ½è±¡ã€‚<br>æ”¯æŒä¸åŒçš„é€šè®¯åè®®ï¼ˆTCP&#x2F;UDPï¼‰</p>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨JavaåŸç”Ÿçš„IO&#x2F;NIOæ¥å£ç¼–å†™ï¼Œ<br>ä¼šç›¸å½“å¤æ‚ç¹çã€‚</p>
<p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æŠŠç³»ç»Ÿä»BIOå‡çº§åˆ°NIOï¼Œ<br>åŸºæœ¬ä¸Šéœ€è¦é‡æ–°å¼€å‘ä¸€è¾¹</p>
<p>è€Œå¦‚æœæˆ‘ä»¬ä¸€å¼€å§‹ä½¿ç”¨Nettyå¼€å‘ï¼Œ<br>IOæ¨¡å‹ã€é€šè®¯åè®®éƒ½å¯ä»¥çš„åˆ‡æ¢å¾—æ›´åŠ é¡ºæ»‘</p>
<h4 id="3ã€äº‹ä»¶æ¨¡å‹"><a href="#3ã€äº‹ä»¶æ¨¡å‹" class="headerlink" title="3ã€äº‹ä»¶æ¨¡å‹"></a>3ã€äº‹ä»¶æ¨¡å‹</h4><blockquote>
<p>åŸºäºæ‹¦æˆªå™¨é“¾æ¨¡å¼çš„äº‹ä»¶æ¨¡å‹</p>
</blockquote>
<p>Nettyä½¿ç”¨pipelineï¼Œå®ç°äº†ä¸€ä¸ªç»“æ„æ¸…æ™°å¾—äº‹ä»¶æ¨¡å‹ã€‚</p>
<p>æ¯å½“ä¸€ä¸ªChannelè¢«åˆ›å»ºçš„æ—¶å€™ï¼Œå°±ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªChannelPipelineï¼Œ<br>å¹¶æ°¸ä¹…çš„ç»‘å®šåˆ°è¿™ä¸ªChannelä¸Šã€‚</p>
<p>ä¸€ä¸ªEventäº‹ä»¶è¢«åŠ å…¥åˆ°ï¼Œè§¦å‘ä¸€ä¸ªpipelineï¼Œå…¶ä¸­å¾ˆå¤šçš„Handleræ‰§è¡Œæ“ä½œã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥å®ç°è‡ªå·±çš„Handleræ¥å¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚<br>è€Œä¸ä¼šç ´åä»£ç ã€‚</p>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/HgrHQm.png"></p>
<p>è€Œå¯¹äºæˆ‘ä»¬å¼€å‘Nettyåº”ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½®å¥½Nettyï¼Œ<br>ç„¶åå†™å¥½è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘Handlerï¼Œå¹¶åŠ å…¥åˆ°Pipelineä¸­ã€‚<br>å…¶ä»–çš„äº¤ç»™Nettyå°±å¥½äº†ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚</p>
<h3 id="ä¼ è¾“æœåŠ¡"><a href="#ä¼ è¾“æœåŠ¡" class="headerlink" title="ä¼ è¾“æœåŠ¡"></a>ä¼ è¾“æœåŠ¡</h3><blockquote>
<p>å¤„ç†åŸºäºæµçš„ä¼ è¾“</p>
</blockquote>
<p>åœ¨åŸºäºTCP&#x2F;IPçš„åŸºäºæµçš„åè®®ä¸­ï¼Œæ•°æ®åŒ…éƒ½æ˜¯åŸºäºå­—èŠ‚æµçš„ã€‚<br>æ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®åŒ…ä¸­ï¼Œå¯èƒ½ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æˆ‘ä»¬éœ€è¦çš„æ•°æ®åŒ…ã€‚</p>
<p>æ‰€ä»¥åœ¨æ•°æ®åŒ…çš„å¤„ç†ä¸Šï¼Œå°±ä¼šæœ‰å¾ˆå¤šç¹ççš„å·¥ä½œå†…å®¹ã€‚<br>æ‹†åŒ…ã€è£…åŒ…</p>
<p>æ‰€ä»¥Nettyæä¾›äº†ä¸€ä¸ªå¯ä»¥æ‰©å±•çš„ç±»<code>ByteToMessageDecoder</code><br>é‡Œé¢æä¾›å¾ˆå¤šå¼€ç®±å³ç”¨çš„ç¼–ç ã€è§£ç å™¨ã€‚<br>åˆæ¬¡ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç¼–å†™è‡ªå·±çš„å®šåˆ¶ç¼–ç ã€è§£ç å™¨ã€‚</p>
<p>åœ¨TCPçš„ä¸–ç•Œä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®ä¼ è¾“éƒ½æ˜¯åŸºäºå­—èŠ‚æµçš„ã€‚<br>ä½†æ˜¯Nettyæä¾›äº†ä¸€ç§å°è£…ï¼Œ<br>å¯ä»¥åŒæ—¶è§£å†³ç²˜åŒ…ã€æ‹†åŒ…çš„é—®é¢˜ï¼Œè¿˜å¯ä»¥ç»™è½¬æ¢æˆPOJOå¯¹è±¡ã€‚<br>è¿™æ ·è§£ç å™¨ç›´æ¥è§£å‡ºæ¥çš„å°±æ˜¯ä¸€ä¸ªJavaå¯¹è±¡ã€‚æ›´ä¼˜é›…ã€‚</p>
<h3 id="åè®®æ”¯æŒ"><a href="#åè®®æ”¯æŒ" class="headerlink" title="åè®®æ”¯æŒ"></a>åè®®æ”¯æŒ</h3><p>Nettyå®ç°äº†å„ç§é«˜çº§çš„ä¼ è¾“åè®®ã€‚<br>æ¯”å¦‚ï¼šHTTPã€SSLã€WebSocketsç­‰ç­‰ã€‚<br>æˆ‘ä»¬ç”šè‡³å¯ä»¥ç¼–å†™è‡ªå·±çš„åè®®ã€‚</p>
<h2 id="Nettyå®æˆ˜"><a href="#Nettyå®æˆ˜" class="headerlink" title="Nettyå®æˆ˜"></a>Nettyå®æˆ˜</h2><p>æ¥ä¸‹æ¥  æˆ‘ä»¬ç®€å•å†™ä¸€ä¸ªNettyçš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„demoã€‚<br>æˆ‘ä»¬ä½¿ç”¨SpringBootæ¥å¿«é€Ÿæ¶æ„é¡¹ç›®ã€‚<br>ä½¿ç”¨Gradleæ„å»º<br>è¿™é‡Œæ˜¯ä½¿ç”¨çš„æ˜¯Netty 4.1.77ï¼Œæ¯”è¾ƒç¨³å®šçš„ç‰ˆæœ¬ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="attr">group:</span> <span class="string">&#x27;io.netty&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;netty-all&#x27;</span>, <span class="attr">version:</span> <span class="string">&#x27;4.1.77.Final&#x27;</span></span><br><span class="line">    compileOnly <span class="attr">group:</span> <span class="string">&#x27;org.projectlombok&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;lombok&#x27;</span>, <span class="attr">version:</span> <span class="string">&#x27;1.18.24&#x27;</span></span><br><span class="line">    annotationProcessor <span class="string">&#x27;org.projectlombok:lombok:1.18.24&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter&#x27;</span></span><br><span class="line">    testImplementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><p>æˆ‘ä»¬å†™ä¸€ä¸ªNettyæœåŠ¡ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ol>
<li>æ„å»ºä¸€ä¸ªå¯åŠ¨å™¨</li>
<li>åˆ›å»ºEventLoopGroup</li>
<li>æ„å»ºChildHandlerså’ŒPipeline</li>
<li>ç¼–å†™è‡ªå·±çš„ä¸šåŠ¡Handlerå¹¶åŠ å…¥Pipeline</li>
<li>å¯åŠ¨å™¨ç»‘å®šç«¯å£</li>
</ol>
<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cp.easychat.server.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ws://localhost:8080/chat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> NioEventLoopGroup boss;</span><br><span class="line">	<span class="keyword">private</span> NioEventLoopGroup workers;</span><br><span class="line">	<span class="keyword">private</span> ServerBootstrap serverBootstrap;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.init();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">			log.info(<span class="string">&quot;server start success.&quot;</span>);</span><br><span class="line">			future.channel().closeFuture().sync();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// é…ç½®å¯åŠ¨å™¨</span></span><br><span class="line">		serverBootstrap = <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">		serverBootstrap.option(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>);</span><br><span class="line">		serverBootstrap.option(ChannelOption.TCP_NODELAY, <span class="literal">true</span>);</span><br><span class="line">		serverBootstrap.option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">		boss = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">		workers = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">		serverBootstrap.group(boss, workers)</span><br><span class="line">				.channel(NioServerSocketChannel.class)</span><br><span class="line">				.childHandler(getChildHandlers());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ChannelHandler <span class="title function_">getChildHandlers</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">				<span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">				pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());<span class="comment">// httpåè®®çš„ç¼–è§£ç å™¨</span></span><br><span class="line">				pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());<span class="comment">// å¤§æ•°æ®æµæ”¯æŒï¼Œ åˆ‡æˆå°å—ä¼ è¾“</span></span><br><span class="line">				pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">64</span>*<span class="number">1024</span>));<span class="comment">// èšåˆå™¨ï¼Œå¯¹åº”ä¸Šé¢çš„åˆ‡å—</span></span><br><span class="line">				pipeline.addLast(<span class="keyword">new</span> <span class="title class_">WebSocketServerProtocolHandler</span>(<span class="string">&quot;/chat&quot;</span>));<span class="comment">// æ¡æ‰‹ å¿ƒè·³å¤„ç†</span></span><br><span class="line">				pipeline.addLast(<span class="keyword">new</span> <span class="title class_">MyWebSocketHandler</span>());<span class="comment">// æˆ‘çš„ä¸šåŠ¡å¤„ç†Handler</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// æˆ‘çš„ä¸šåŠ¡å¤„ç†é€»è¾‘</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyWebSocketHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸Šçº¿</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			log.info(<span class="string">&quot;â¬† new connection from &#123;&#125;&quot;</span>, ctx.channel().remoteAddress());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸‹çº¿</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			log.info(<span class="string">&quot; â¬‡ï¸ï¸ up connection close from &#123;&#125;&quot;</span>, ctx.channel().remoteAddress());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// è¯»å–æ¶ˆæ¯ï¼Œå¹¶è¿”å›</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			log.info(<span class="string">&quot; ğŸ†• New Message: &#123;&#125;, from &#123;&#125;&quot;</span>, msg, ctx.channel().remoteAddress());</span><br><span class="line">			<span class="keyword">if</span> (! (msg <span class="keyword">instanceof</span> TextWebSocketFrame)) &#123;</span><br><span class="line">				log.error(<span class="string">&quot;message is not text, &#123;&#125;&quot;</span>, msg);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="type">TextWebSocketFrame</span> <span class="variable">request</span> <span class="operator">=</span> (TextWebSocketFrame) msg;</span><br><span class="line">			log.info(<span class="string">&quot;received text message : &#123;&#125;&quot;</span>, request);</span><br><span class="line"></span><br><span class="line">			ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(<span class="string">&quot;server send :&quot;</span> + request.text()));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç¼–å†™å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨æœåŠ¡å™¨ï¼Œ<br>å¹¶ä½¿ç”¨åœ¨çº¿Websocketå·¥å…·è°ƒç”¨æµ‹è¯•ä¸€ä¸‹</p>
<h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><p>å®¢æˆ·ç«¯çš„ç¼–å†™å’ŒæœåŠ¡ç«¯ç±»ä¼¼ï¼Œ<br>ä½†æ˜¯æœ‰äº›åœ°æ–¹ä¸ä¸€æ ·ã€‚<br>éœ€è¦æœåŠ¡ç«¯ä¸»åŠ¨å‘èµ·è¿æ¥ã€‚</p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ„å»ºä¸€ä¸ªå¯åŠ¨å™¨</li>
<li>åˆ›å»ºEventLoopGroup</li>
<li>æ„å»ºChildHandlerså’ŒPipeline</li>
<li>åœ¨ä¸šåŠ¡Handlerä¸­ï¼Œéœ€è¦æ·»åŠ å‘èµ·æ¡æ‰‹æ“ä½œ</li>
<li>å¯åŠ¨å™¨å‘èµ·è¿æ¥</li>
</ol>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cp.client.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPromise;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.FullHttpResponse;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpClientCodec;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketClientHandshakerFactory;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketVersion;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebsocketClient</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> URI uri;</span><br><span class="line">	<span class="keyword">private</span> Bootstrap bootstrap;</span><br><span class="line">	<span class="keyword">private</span> EventLoopGroup eventLoopGroup;</span><br><span class="line">	<span class="keyword">private</span> ChannelPromise channelPromise;</span><br><span class="line">	<span class="keyword">private</span> Channel channel;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">WebsocketClient</span><span class="params">(URI uri)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.uri = uri;</span><br><span class="line">		<span class="built_in">this</span>.init();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			channel = bootstrap.connect(uri.getHost(), uri.getPort()).sync().channel();</span><br><span class="line">			channelPromise.sync();</span><br><span class="line">			log.info(<span class="string">&quot;connect success and handshake complete.&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot;connect error, &quot;</span> + e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">		bootstrap = <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">		bootstrap.option(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>);</span><br><span class="line">		bootstrap.option(ChannelOption.TCP_NODELAY, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		eventLoopGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line">		bootstrap.group(eventLoopGroup)</span><br><span class="line">				.channel(NioSocketChannel.class)</span><br><span class="line">				.handler(getHandlers());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ChannelHandler <span class="title function_">getHandlers</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">				<span class="type">ChannelPipeline</span> <span class="variable">channelPipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">				channelPipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpClientCodec</span>());</span><br><span class="line">				channelPipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">1048576</span>));</span><br><span class="line">				channelPipeline.addLast(<span class="keyword">new</span> <span class="title class_">MyWebSocketHandler</span>(getHandShaker(uri)));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">private</span> WebSocketClientHandshaker <span class="title function_">getHandShaker</span><span class="params">(URI uri)</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> WebSocketClientHandshakerFactory</span><br><span class="line">						.newHandshaker(uri, WebSocketVersion.V13, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebSocketHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> WebSocketClientHandshaker handShaker;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="title function_">MyWebSocketHandler</span><span class="params">(WebSocketClientHandshaker handShaker)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.handShaker = handShaker;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			channelPromise = ctx.newPromise();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			log.info(<span class="string">&quot;handshake to : &#123;&#125;&quot;</span>, ctx.channel().remoteAddress());</span><br><span class="line">			<span class="built_in">this</span>.handShaker.handshake(ctx.channel());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">			log.info(<span class="string">&quot;receive data &#123;&#125; from &#123;&#125;&quot;</span>, msg, ctx.channel().remoteAddress());</span><br><span class="line">			<span class="keyword">if</span> (handShaker.isHandshakeComplete()) &#123;</span><br><span class="line">				finishHandShaker(ctx, msg);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// handle business data</span></span><br><span class="line">			<span class="keyword">if</span> (!(msg <span class="keyword">instanceof</span> TextWebSocketFrame)) &#123;</span><br><span class="line">				log.warn(<span class="string">&quot;&#123;&#125; is not a text message.&quot;</span>, msg);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="type">TextWebSocketFrame</span> <span class="variable">textMsg</span> <span class="operator">=</span> (TextWebSocketFrame) msg;</span><br><span class="line">			log.info(<span class="string">&quot;client receive a message: &#123;&#125;&quot;</span>, textMsg.text());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finishHandShaker</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				handShaker.finishHandshake(ctx.channel(), (FullHttpResponse) msg);</span><br><span class="line">				channelPromise.setSuccess();</span><br><span class="line">				log.info(<span class="string">&quot;handShake success.&quot;</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(e.getMessage(), e);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å®Œæ•´ä»£ç è¯·ç‚¹å‡»<a href="https://github.com/CPyeah/easy-chat">è¿™é‡Œ</a></p>
<h2 id="Nettyåœ¨å¼€æ”¾å¹³å°ä¸­çš„åº”ç”¨"><a href="#Nettyåœ¨å¼€æ”¾å¹³å°ä¸­çš„åº”ç”¨" class="headerlink" title="Nettyåœ¨å¼€æ”¾å¹³å°ä¸­çš„åº”ç”¨"></a>Nettyåœ¨å¼€æ”¾å¹³å°ä¸­çš„åº”ç”¨</h2><p>åœ¨æˆ‘ä»¬çš„å¼€æ”¾å¹³å°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡Websocketå¯¹å®¢æˆ·ç«¯æ¨é€ä¸€ä¸‹æ¶ˆæ¯ã€‚<br>æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨Nettyæ­å»ºäº†ä¸€ä¸ªWebscoketæœåŠ¡å™¨ã€‚</p>
<p>å…·ä½“æ­å»ºæ­¥éª¤è·Ÿä¸Šé¢å·®ä¸å¤šã€‚</p>
<p>ä½†æ˜¯å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œæƒé™çš„æ ¡éªŒå¾ˆé‡è¦ã€‚</p>
<p>æ‰€ä»¥åœ¨æ¯ä¸€ä¸ªé“¾æ¥å»ºç«‹ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šå‘èµ·ç™»å½•æ“ä½œã€‚<br>å¦‚æœç™»å½•æˆåŠŸï¼ŒæœåŠ¡ç«¯ä¼šæŠŠå®¢æˆ·ç«¯çš„ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œç»´æŒä¼šè¯ã€‚</p>
<p>åœ¨æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆç›‘å¬ä¸šåŠ¡ä¸­å°çš„MQæ¶ˆæ¯ã€‚<br>å¦‚æœæ¶ˆæ¯æœ‰å¯¹åº”çš„å®¢æˆ·ç«¯åœ¨çº¿ï¼Œæˆ‘ä»¬æŠŠæ¶ˆæ¯å†…å®¹ï¼Œ<br>å°è£…æˆ<code>Message</code>å¯¹è±¡ï¼Œæ¨é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>ç„¶åå®¢æˆ·ç«¯æ¥å—åˆ°æ¶ˆæ¯ä¹‹åï¼Œä¼šå‘èµ·ä¸€ä¸ªæ¶ˆæ¯ç¡®è®¤ï¼Œä»¥ä¿è¯æ¶ˆæ¯é¡ºåˆ©è¢«æ¥æ”¶ã€‚</p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://cp-images.oss-cn-hangzhou.aliyuncs.com/5cnd8k.png"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Nettyçš„ç›¸å…³çŸ¥è¯†ã€‚å¹¶å®æ“ç»ƒä¹ äº†ä¸€ä¸‹ã€‚<br>æˆ‘ä»¬çŸ¥é“äº†Nettyæ˜¯Javaä¸–ç•Œä¸­æœ€é‡è¦çš„NIOæ¡†æ¶ã€‚<br>å®ƒå¯¹java.nioçš„å°è£…ï¼Œå®ƒçš„äº‹ä»¶ï¼Œååº”æ¨¡å‹éƒ½å¯¹æˆ‘ä»¬å¼€å‘NIOæœåŠ¡å™¨éå¸¸æœ‰ç”¨ã€‚<br>å®ƒçš„å¤šè·¯å¤ç”¨çš„æ¨¡å‹ä¹Ÿéå¸¸é‡è¦ã€‚</p>
<p>æˆ‘ä»¬è¿˜ä¸€èµ·æ­å»ºäº†ä¸€ä¸ªç®€å•çš„NettyæœåŠ¡ï¼Œ<br>å¹¶ä½¿ç”¨Nettyç¼–å†™äº†ä¸€ä¸ªç®€å•çš„Nettyå®¢æˆ·ç«¯ã€‚<br>å¸®åŠ©å¤§å®¶ä¸Šæ‰‹å…¥é—¨ã€‚</p>
<p>è¿˜æœ‰æˆ‘å¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯å¦‚ä½•ä½¿ç”¨Nettyæ­å»ºä¸€ä¸ªå¼€æ”¾å¹³å°çš„æ¶ˆæ¯æ¨é€ç³»ç»Ÿçš„ã€‚<br>ä¾›å¤§å®¶å‚è€ƒã€‚</p>
<p>å¸Œæœ›è¿™ç‰‡æ–‡ç« èƒ½è®©å¤§å®¶æœ‰æ‰€æ”¶è·ï¼</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a target="_blank" rel="noopener" href="https://netty.io/">https://netty.io/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.kegel.com/c10k.html">http://www.kegel.com/c10k.html</a></li>
<li><a target="_blank" rel="noopener" href="https://gee.cs.oswego.edu/dl/cpjslides/nio.pdf">https://gee.cs.oswego.edu/dl/cpjslides/nio.pdf</a></li>
<li><a href="https://github.com/netty/netty">https://github.com/netty/netty</a></li>
<li><a href="https://github.com/netty/netty/wiki/User-guide-for-4.x">https://github.com/netty/netty/wiki/User-guide-for-4.x</a></li>
<li><a target="_blank" rel="noopener" href="https://netty.io/3.8/guide/#architecture">https://netty.io/3.8/guide/#architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=I8yy2Cy7dDI">https://www.youtube.com/watch?v=I8yy2Cy7dDI</a></li>
<li><a target="_blank" rel="noopener" href="https://alibaba-cloud.medium.com/essential-technologies-for-java-developers-i-o-and-netty-ec765676fd21">https://alibaba-cloud.medium.com/essential-technologies-for-java-developers-i-o-and-netty-ec765676fd21</a></li>
<li><a target="_blank" rel="noopener" href="https://liakh-aliaksandr.medium.com/java-sockets-i-o-blocking-non-blocking-and-asynchronous-fb7f066e4ede">https://liakh-aliaksandr.medium.com/java-sockets-i-o-blocking-non-blocking-and-asynchronous-fb7f066e4ede</a></li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>Copyrightï¼š </strong>
          
          Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        åˆ†äº«
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://github.com/CPyeah/2021/12/25/java/Java%E4%B9%8BNetty/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/netty/" rel="tag">netty</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2022/03/05/java/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
        <div class="article-nav-title">
          
            æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº
          
        </div>
      </a>
    
    
      <a href="/2021/11/27/go/basic-grammar/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
        <div class="article-nav-title">Goè¯­è¨€å­¦ä¹ -å¿«é€Ÿå…¥é—¨</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2022
        <i class="ri-heart-fill heart_icon"></i> chengpeng
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="chengpeng&#39;s blogs"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/java">JAVA</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/go">GO</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/database">æ•°æ®åº“</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/system-design">ç³»ç»Ÿè®¾è®¡</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/algorithm">ç®—æ³•</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/devops">DevOps</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/english">è‹±è¯­å­¦ä¹ </a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">æ ‡ç­¾</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">æ”¯ä»˜å®</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">å¾®ä¿¡</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>